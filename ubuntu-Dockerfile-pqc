FROM ubuntu:22.04

# Install dependencies
RUN apt-get update && apt-get install -y \
    build-essential cmake python3 python3-pip git clang \
    libssl-dev libsystemd-dev \
    && rm -rf /var/lib/apt/lists/*

# Clone SymCrypt and build it
WORKDIR /symcrypt
RUN git clone https://github.com/microsoft/SymCrypt.git . \
    && git submodule update --init \
    && pip3 install -r scripts/requirements.txt \
    && python3 scripts/build.py cmake build --config Release

# Install SymCrypt libraries and headers
RUN cp bin/module/AMD64/LinuxUserMode/libsymcrypt.so /usr/lib/ \
    && cp inc/* /usr/include/

# Clone SymCrypt-OpenSSL and build it
WORKDIR /symcrypt-openssl
RUN git clone https://github.com/microsoft/SymCrypt-OpenSSL.git . \
    && mkdir bin && cd bin \
    && cmake .. \
       -DCMAKE_TOOLCHAIN_FILE=../cmake-toolchain/LinuxUserMode-AMD64.cmake \
       -DSYMCRYPT_ROOT_DIR=/symcrypt \
       -DCMAKE_BUILD_TYPE=Release \
    && cmake --build . --parallel

# Optional: Run tests or samples
# WORKDIR /symcrypt-openssl/bin
# RUN ./SslPlay/SslPlay
